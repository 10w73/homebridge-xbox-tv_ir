<div>
  <img src="./homebridge-xbox-tv.png" style="text-align: center;" height="150" />
</div>

<div class="card card-body">
  <form id="configForm">
    <div class="text-center">
      <label id="info">Authorization Manager</label><br><br>
      </div>
    <div class="form-group">
      <label for="deviceNameInput">Name</label>
      <input type="text" class="form-control" id="deviceNameInput" readonly><br>
      <label for="deviceHostInput">Host</label>
      <input type="text" class="form-control" id="deviceHostInput" readonly><br>
      <label for="deviceTokenInput">Web Api Token</label>
      <input type="text" class="form-control" id="deviceTokenInput">
    </div>
    <div class="text-center">
      <button id="startAuthorizationButton" type="button" class="btn btn-primary">Start authorization</button>
      <button id="authorizeConsoleButton" type="button" class="btn btn-primary">Authorize console</button>
      <button id="configButton" type="button" class="btn btn-primary">Show Config</button>
    </div>
  </form>
</div>

<script>
  (async () => {
    // get the initial config - this is an array potentially containing multiple config blocks
    const pluginConfig = await homebridge.getPluginConfig();
    const devicesCount = pluginConfig[0].devices.length;

    // get the intial from the config and add it to the form
    if (pluginConfig.length) {
      for (let i = 0; i < devicesCount; i++) {
        const deviceName = pluginConfig[0].devices[i].name;
        const deviceHost = pluginConfig[0].devices[i].host;
        const deviceClientId = pluginConfig[0].devices[i].clientID;
        const deviceClientSecret = pluginConfig[0].devices[i].clientSecret;
        const deviceWebApiToken = pluginConfig[0].devices[i].xboxWebApiToken;
        const deviceWebApiControl = pluginConfig[0].devices[i].webApiControl;

        //create consoles buttons
        const button = document.createElement("button");
        button.setAttribute("type", "button");
        button.setAttribute("id", "button" + i);
        button.setAttribute("class", "btn btn-primary");
        button.innerText = deviceName;
        button.style.width = '150px';
        button.style.height = '38x';
        document.body.appendChild(button);

        //load on first run
        document.querySelector('#deviceNameInput').value = pluginConfig[0].devices[0].name;
        document.querySelector('#deviceHostInput').value = pluginConfig[0].devices[0].host;
        //document.querySelector('#deviceClientIdInput').value = pluginConfig[0].devices[0].clientID;
        //document.querySelector('#deviceClientSecretInput').value = pluginConfig[0].devices[0].clientSecret;
        document.querySelector('#deviceTokenInput').value = pluginConfig[0].devices[0].xboxWebApiToken;

        //get actuall value on console select
        document.getElementById('button' + i).addEventListener('click', async () => {
          document.querySelector('#deviceNameInput').value = deviceName;
          document.querySelector('#deviceHostInput').value = deviceHost;
          //document.querySelector('#deviceClientIdInput').value = clientID;
          //document.querySelector('#deviceClientSecretInput').value = clientSecret;
          document.querySelector('#deviceTokenInput').value = deviceWebApiToken;

          const startAuthorizationButton = document.getElementById('startAuthorizationButton');
          const activationStepByStep = document.getElementById('info');
          if (deviceWebApiToken.length > 0 || deviceWebApiControl) {
            activationStepByStep.innerHTML = 'Authorization Manager';
            startAuthorizationButton.setAttribute('disabled', 'disabled');
          } else {
            activationStepByStep.innerHTML = 'First open config menu and set *Device Name*, *Address IP*, *Live ID*, do not enable *Web Api Control* now. Save config and start authorization process.';
            startAuthorizationButton.removeAttribute('disabled');
          }

          this.deviceIndex = i;
        });
        this.deviceIndex = 0;
      }
      // disable start authorization
      const deviceTokenInput = document.getElementById('deviceTokenInput');
      const webApiTokenStartLength = pluginConfig[0].devices[0].xboxWebApiToken.length;
      if (webApiTokenStartLength > 0) {
          document.getElementById('startAuthorizationButton').setAttribute('disabled', 'disabled');
      }
      deviceTokenInput.setAttribute('readonly', true);
      document.getElementById('authorizeConsoleButton').setAttribute('disabled', 'disabled');
    } else {
      document.getElementById('configButton').setAttribute('disabled', 'disabled');
      document.getElementById('startAuthorizationButton').setAttribute('disabled', 'disabled');
      document.getElementById('authorizeConsoleButton').setAttribute('disabled', 'disabled');
      homebridge.showSchemaForm();
    }

    // watch for changes to the form and update the config
    document.getElementById('configForm').addEventListener('input', () => {
      // get the current values from the form
      pluginConfig[0].devices[this.deviceIndex].name = document.querySelector('#deviceNameInput').value;
      pluginConfig[0].devices[this.deviceIndex].host = document.querySelector('#deviceHostInput').value;
      //pluginConfig[0].devices[this.deviceIndex].clientID = document.querySelector('#deviceClientIdInput').value;
      //pluginConfig[0].devices[this.deviceIndex].clientSecret = document.querySelector('#deviceClientSecretInput').value;
      pluginConfig[0].devices[this.deviceIndex].xboxWebApiToken = document.querySelector('#deviceTokenInput').value;

      // update the config
      homebridge.updatePluginConfig(pluginConfig);
    });

    const configButton = document.getElementById('configButton');
    document.querySelector('#configButton').addEventListener('click', async () => {
      if (this.configButtonState) {
        configButton.innerText = "Show Config";
        homebridge.hideSchemaForm();
        this.configButtonState = false;
      } else {
        configButton.innerText = "Hide Config";
        homebridge.showSchemaForm();
        this.configButtonState = true;
      }
    });


    // watch for click events on the startAuthorizationButton
    document.querySelector('#startAuthorizationButton').addEventListener('click', async () => {
      // validate a token was provided
      const webApiToken = document.querySelector('#deviceTokenInput').value;
      const host = document.querySelector('#deviceHostInput').value;
      const clientId = '5e5ead27-ed60-482d-b3fc-702b28a97404';
      const clientSecret = '';

      // starting the request, show the loading spinner
      homebridge.showSpinner();

      // request a token from the server
      try {
        const response = await homebridge.request('/data', {
          token: webApiToken,
          host: host,
          clientId: clientId,
          clientSecret: clientSecret
        });

        const data = response.data;
        const status = response.status;
        const startAuthorizationButton = document.getElementById('startAuthorizationButton');
        const authorizeConsoleButton = document.getElementById('authorizeConsoleButton');
        const activationStepByStep = document.getElementById('info');
        const deviceTokenInput = document.getElementById('deviceTokenInput');

        if (status == 0) {
          startAuthorizationButton.setAttribute('disabled', 'disabled');
          startAuthorizationButton.innerText = "Start authorization";
          authorizeConsoleButton.setAttribute('disabled', 'disabled');
          authorizeConsoleButton.innerText = "Authorize console";
          activationStepByStep.innerHTML =
            'Console already authorized. To start new athorization process please remove the *authToken_xxxx* file from the storage device. The file is stored in */var/lib/homebridge/xboxTv* folder.';
          homebridge.toast.info('Console already authorized!.', 'Info!');
        }

        if (status == 1) {
          startAuthorizationButton.setAttribute('disabled', 'disabled');
          authorizeConsoleButton.removeAttribute('disabled');
          authorizeConsoleButton.innerText = "Authorize console";
          activationStepByStep.innerHTML =
            'Authorization proces started, now press the *Authorize Console* button.';
          homebridge.toast.info('Authorization proces started!', 'Info!');
          document.querySelector('#authorizeConsoleButton').addEventListener('click', async () => {
            if (this.authorizeConsole) {
              const token = document.querySelector('#deviceTokenInput').value;
              pluginConfig[0].devices[this.deviceIndex].xboxWebApiToken = token;
              homebridge.updatePluginConfig(pluginConfig);
              homebridge.savePluginConfig(pluginConfig);
              deviceTokenInput.setAttribute('readonly', true);
              authorizeConsoleButton.setAttribute('disabled', 'disabled');
              startAuthorizationButton.removeAttribute('disabled');
              startAuthorizationButton.innerText = "Activate console";
              activationStepByStep.innerHTML ='Token saved successful, now please press *Activate Console* button.';
              homebridge.toast.info('Token saved successful!.', 'Info!');
              this.authorizeConsole = false;
            } else {
              await open(data);
              deviceTokenInput.setAttribute('readonly', false);
              authorizeConsoleButton.innerText = "Save token";
              activationStepByStep.innerHTML = 'Now please go to the opened window and accept permiossion for this app, next copy the part after *?code=* from the response URI and paste it in to the *Web Api Token*, next press the *Save Token* button.';
              homebridge.toast.info('Authorization page requested!', 'Info!');
              this.authorizeConsole = true;
            }
          });
        }

        if (status == 2) {
          startAuthorizationButton.setAttribute('disabled', 'disabled');
          startAuthorizationButton.innerText = "Start authorization";
          authorizeConsoleButton.setAttribute('disabled', 'disabled');
          authorizeConsoleButton.innerText = "Authorize console";
          activationStepByStep.innerHTML = 'Authorization URL empty, start authorize console again.';
          homebridge.toast.warning('Authorization URL empty, start authorize console again.', 'Warning!');
        }

        if (status == 3) {
          startAuthorizationButton.setAttribute('disabled', 'disabled');
          startAuthorizationButton.innerText = "Start authorization";
          authorizeConsoleButton.setAttribute('disabled', 'disabled');
          authorizeConsoleButton.innerText = "Authorize console";
          activationStepByStep.innerHTML =
            'Activation console done, Token file saved successful. Now enable *Web Api Control* in config menu, save and restart the plugin and have fan!!!';
          homebridge.toast.success('Activation done, Token File saved.', 'Success!');

        }

        if (status == 4) {
          startAuthorizationButton.removeAttribute('disabled');
          startAuthorizationButton.innerText = "Start authorization";
          authorizeConsoleButton.setAttribute('disabled', 'disabled');
          authorizeConsoleButton.innerText = "Authorize console";
          activationStepByStep.innerHTML = 'Authorization and Token file saved error.';
          homebridge.toast.error('Activation and Token File saved error.', 'Error!');
        }

      } catch (e) {
        homebridge.toast.error('Failed to get data try again.', 'Error!');
      } finally {
        // remember to un-hide the spinner
        homebridge.hideSpinner();
      }
    });
  })();
</script>