<body>
  <div>
    <img src="homebridge-xbox-tv.png" style="text-align: center;" height="150" />
  </div>

  <div id="authorizationManager" style="display: none;" class="card card-body">
    <form id="configForm">
      <div class="text-center">
        <label id="deviceNameInput" style="font-size: 23px">Xbox</label><br>
      </div>
      <div class="text-center">
        <div class="text-center">
          <label id="info" style="text-align: center; font-size: 17px; color: white;">Authorization
            Manager</label><br><br>
        </div>
      </div>
      <div class="form-group">
        <label for="deviceHostInput">Host</label>
        <input type="text" class="form-control" id="deviceHostInput"><br>
        <label for="deviceLiveId">Xbox Live ID</label>
        <input type="text" class="form-control" id="deviceLiveId"><br>
        <label for="deviceTokenInput">Web Api Token</label>
        <input type="text" class="form-control" id="deviceTokenInput"><br>
        <label for="deviceWebApiControl">Web Api Control</label>
        <input type="checkbox" class="form-control" id="deviceWebApiControl">
      </div>
      <div class="text-center">
        <button id="startAuthorizationButton" type="button" class="btn btn-primary">Start authorization</button>
        <button id="authorizeConsoleButton" type="button" class="btn btn-primary">Authorize console</button>
        <button id="clearTokenButton" type="button" class="btn btn-primary">Clear Web Api Token</button>
        <button id="configButton" type="button" class="btn btn-primary"><i class="fas fa-gear"></i></button>
      </div>
    </form>
  </div>
</body>

<script>
  (async () => {
    //get the plugin config array
    const pluginConfig = await homebridge.getPluginConfig();
    const objKeys = Object.keys(pluginConfig[0]);
    const devicesExist = objKeys.includes('devices');

    if (!devicesExist) {
      const devices = { 'devices': [] };
      pluginConfig.push(devices);
      await homebridge.updatePluginConfig(pluginConfig);
      await homebridge.showSchemaForm();
      return;
    }

    //load form
    document.getElementById('authorizationManager').style.display = 'block';

    //get devices count
    const devicesCount = pluginConfig[0].devices.length;

    // get the intial from the config and add it to the form
    this.deviceIndex = 0;
    for (let i = 0; i < devicesCount; i++) {
      //create consoles buttons
      const button = document.createElement("button");
      button.setAttribute("type", "button");
      button.setAttribute("id", "button" + i);
      button.setAttribute("class", "btn btn-secondary");
      button.innerText = pluginConfig[0].devices[i].name || 'Not set';
      button.style.width = '160px';
      button.style.height = '34x';
      document.body.appendChild(button);

      //get actuall value on console select
      document.getElementById('button' + i).addEventListener('click', async () => {
        document.querySelector('#deviceNameInput').innerHTML = pluginConfig[0].devices[i].name || '';
        document.querySelector('#deviceHostInput').value = pluginConfig[0].devices[i].host || '';
        document.querySelector('#deviceLiveId').value = pluginConfig[0].devices[i].xboxLiveId || '';
        document.querySelector('#deviceTokenInput').value = pluginConfig[0].devices[i].xboxWebApiToken || '';
        document.querySelector('#deviceWebApiControl').checked = pluginConfig[0].devices[i].webApiControl || false;
        this.deviceIndex = i;
      });
    };

    //add button show/hide config
    document.getElementById('configButton').addEventListener('click', async () => {
      const configButton = document.getElementById('configButton');
      if (this.configButtonState) {
        await homebridge.hideSchemaForm();
        this.configButtonState = false;
      } else {
        await homebridge.showSchemaForm();
        this.configButtonState = true;
      };
    });

    //load values on first run
    document.querySelector('#deviceNameInput').innerHTML = pluginConfig[0].devices[0].name || '';
    document.querySelector('#deviceHostInput').value = pluginConfig[0].devices[0].host || '';
    document.querySelector('#deviceLiveId').value = pluginConfig[0].devices[0].xboxLiveId || '';
    document.querySelector('#deviceTokenInput').value = pluginConfig[0].devices[0].xboxWebApiToken || '';
    document.querySelector('#deviceWebApiControl').checked = pluginConfig[0].devices[0].webApiControl || false;

    //check token length and adapt buttons
    const tokenLength = (pluginConfig[0].devices[0].xboxWebApiToken).length || 0;
    document.getElementById('authorizeConsoleButton').setAttribute('disabled', 'disabled');
    const setButtonMode = tokenLength <= 10 ? document.getElementById('startAuthorizationButton').innerText = "Start authorization" : document.getElementById('startAuthorizationButton').innerText = "Check state";
    const setCheckboxState = tokenLength <= 10 ? document.getElementById('deviceWebApiControl').checked = false : false;
    const setCheckboxMode = tokenLength <= 10 ? document.getElementById('deviceWebApiControl').disabled = true : false;

    //watch for changes to the form and update the config
    document.getElementById('configForm').addEventListener('input', async () => {
      pluginConfig[0].devices[this.deviceIndex].host = document.querySelector('#deviceHostInput').value;
      pluginConfig[0].devices[this.deviceIndex].xboxLiveId = document.querySelector('#deviceLiveId').value;
      pluginConfig[0].devices[this.deviceIndex].xboxWebApiToken = document.querySelector('#deviceTokenInput').value;
      pluginConfig[0].devices[this.deviceIndex].webApiControl = document.querySelector('#deviceWebApiControl').checked;

      const tokenLength = (pluginConfig[0].devices[this.deviceIndex].xboxWebApiToken).length;
      if (tokenLength <= 10) {
        document.getElementById('startAuthorizationButton').innerText = "Start authorization";
        document.getElementById('startAuthorizationButton').removeAttribute('disabled');
      } else {
        document.getElementById('authorizeConsoleButton').setAttribute('disabled', 'disabled');
      }

      await homebridge.savePluginConfig(pluginConfig);
      await homebridge.updatePluginConfig(pluginConfig);
    });

    //clear token file
    document.getElementById('clearTokenButton').addEventListener('click', async () => {
      homebridge.showSpinner();

      try {
        const host = pluginConfig[0].devices[this.deviceIndex].host || '';
        const payload = {
          host: host
        };
        const response = await homebridge.request('/clearToken', payload);

        if (response) {
          pluginConfig[0].devices[this.deviceIndex].xboxWebApiToken = '';
          document.querySelector('#deviceTokenInput').value = '';
          document.getElementById('startAuthorizationButton').removeAttribute("disabled");
          document.getElementById('startAuthorizationButton').innerText = "Start authorization";
          document.getElementById('deviceWebApiControl').checked = false;
          document.getElementById('deviceWebApiControl').disabled = true;
          document.getElementById('info').innerHTML = 'Web Api Token cleared, now You can start new authorization process.';
          document.getElementById('info').style.color = 'green';
          homebridge.toast.info('Web Api Token cleared!', 'Info!');

          await homebridge.savePluginConfig(pluginConfig);
          await homebridge.updatePluginConfig(pluginConfig);
        };

        homebridge.hideSpinner();
      } catch (e) {
        homebridge.toast.error('Web Api Token clear failed.', 'Error!');
        homebridge.hideSpinner();
      };
    });

    //watch for click on the Start authorization button
    document.getElementById('startAuthorizationButton').addEventListener('click', async () => {
      await homebridge.updatePluginConfig(pluginConfig);
      homebridge.showSpinner();

      try {
        const host = pluginConfig[0].devices[this.deviceIndex].host || '';
        this.clientId = pluginConfig[0].devices[this.deviceIndex].clientId || '5e5ead27-ed60-482d-b3fc-702b28a97404';
        this.clientSecret = pluginConfig[0].devices[this.deviceIndex].clientSecret || '';
        this.userToken = pluginConfig[0].devices[this.deviceIndex].userToken || '';
        this.uhs = pluginConfig[0].devices[this.deviceIndex].uhs || '';
        this.xboxWebApiToken = pluginConfig[0].devices[this.deviceIndex].xboxWebApiToken || '';
        const payload = {
          host: host,
          clientId: this.clientId,
          clientSecret: this.clientSecret,
          userToken: this.userToken,
          uhs: this.uhs,
          webApiToken: this.xboxWebApiToken
        };

        const response = await homebridge.request('/startAuthorization', payload);
        const info = response.info;
        const status = response.status;

        switch (status) {
          case 0:
            document.getElementById('info').innerHTML = 'Console authorized and activated. To start new process please clear Web API Token first.';
            document.getElementById('info').style.color = 'green';
            document.getElementById('authorizeConsoleButton').setAttribute('disabled', 'disabled');
            document.getElementById('authorizeConsoleButton').innerText = "Authorize console";
            document.getElementById('deviceWebApiControl').disabled = false;
            break;
          case 1:
            document.getElementById('info').innerHTML = 'Authorization process started, now press the *Authorize Console*.';
            document.getElementById('info').style.color = 'yellow';
            document.getElementById('startAuthorizationButton').setAttribute('disabled', 'disabled');
            document.getElementById('authorizeConsoleButton').removeAttribute('disabled');
            document.getElementById('authorizeConsoleButton').innerText = "Authorize console";
            document.getElementById('deviceWebApiControl').checked = false;
            document.getElementById('deviceWebApiControl').disabled = true;
            this.authorizeConsole = false;
            document.getElementById('authorizeConsoleButton').addEventListener('click', async () => {
              if (!this.authorizeConsole) {
                document.getElementById('info').innerHTML = 'Now go to the pop-up window, login to Your Xbox Live account and allow this plugin. Next from the response URI copy the part after *?code=* and paste it to the *Web Api Token*, next press *Activate Console*.';
                document.getElementById('info').style.color = 'yellow';
                document.getElementById('authorizeConsoleButton').setAttribute('disabled', 'disabled');
                document.getElementById('startAuthorizationButton').removeAttribute('disabled');
                document.getElementById('startAuthorizationButton').innerText = "Activate console";
                document.getElementById('deviceWebApiControl').checked = false;
                document.getElementById('deviceWebApiControl').disabled = true;
                await open(info)
                this.authorizeConsole = true;
              };
            });
            break;
          case 2:
            document.getElementById('info').innerHTML = 'Activation done, now enable *Web Api Control*, restart plugin and have fun!!!';
            document.getElementById('info').style.color = 'green';
            document.getElementById('startAuthorizationButton').setAttribute('disabled', 'disabled');
            document.getElementById('startAuthorizationButton').innerText = "Start authorization";
            document.getElementById('authorizeConsoleButton').setAttribute('disabled', 'disabled');
            document.getElementById('authorizeConsoleButton').innerText = "Authorize console";
            document.getElementById('deviceWebApiControl').disabled = false;

            await homebridge.savePluginConfig(pluginConfig);
            await homebridge.updatePluginConfig(pluginConfig)
            break;
          case 3:
            document.getElementById('info').innerHTML = 'Authorization or Token save error!!!.';
            document.getElementById('info').style.color = 'red';
            startAuthorizationButton.removeAttribute('disabled');
            startAuthorizationButton.innerText = "Start authorization";
            document.getElementById('authorizeConsoleButton').setAttribute('disabled', 'disabled');
            document.getElementById('authorizeConsoleButton').innerText = "Authorize console";
            document.getElementById('deviceWebApiControl').checked = false;
            document.getElementById('deviceWebApiControl').disabled = true;
            homebridge.toast.error(info, 'Error!');
            break;
        };

      } catch (e) {
        homebridge.toast.error('Failed to get data try again.', 'Error!');
      } finally {
        homebridge.hideSpinner();
      };
    });
  })();
</script>